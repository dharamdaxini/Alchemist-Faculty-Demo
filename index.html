<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALCHEMIST v167.0 | STABLE MASTER</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #030509; --card-bg: #0b172a; --dock-bg: #0f203a; 
            --border: #1e2f4a; --accent: #38bdf8; --text-main: #f8fafc; 
            --text-sub: #94a3b8; --gold: #fbbf24; --rank-a: #a855f7;
            --font-ui: 'Inter', sans-serif; --font-book: 'Crimson Pro', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; height: 100vh; background: var(--bg); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; display: flex; flex-direction: column; }

        #stage { flex-grow: 1; position: relative; overflow: hidden; perspective: 1000px; }

        .card { 
            position: absolute; width: 360px; left: 50%; margin-left: -180px; 
            bottom: 220px; top: 70px; background: var(--card-bg); 
            border-radius: 24px 24px 0 0; border: 1px solid var(--border); border-bottom: none;
            display: flex; flex-direction: column; box-shadow: 0 -20px 50px rgba(0,0,0,0.7); 
            transform-origin: center bottom; will-change: transform; overflow: hidden; z-index: 5;
        }

        .rank-tag { 
            position: absolute; top: 18px; left: 22px; font-size: 0.6rem; font-weight: 900; 
            letter-spacing: 1.5px; color: var(--gold); border: 1.5px solid var(--gold); 
            padding: 3px 10px; border-radius: 6px; z-index: 10; text-transform: uppercase;
        }
        .rank-a-glow { border-color: var(--rank-a); color: var(--rank-a); box-shadow: 0 0 15px rgba(168, 85, 247, 0.4); }

        .card-top { flex-grow: 1; padding: 50px 30px 30px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; }
        .goal-header { position: absolute; top: 55px; font-size: 0.65rem; font-weight: 800; color: var(--text-sub); text-transform: uppercase; letter-spacing: 2px; }
        .card-q { font-family: var(--font-book); font-size: 1.6rem; font-weight: 600; line-height: 1.25; color: #fff; }
        .card-overlay-text { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-family: var(--font-book); font-size: 1.3rem; font-weight: 600; color: #fff; opacity: 0; pointer-events: none; width: 85%; text-align: center; text-shadow: 0 5px 20px rgba(0,0,0,1); }

        .card-dock { position: absolute; bottom: 0; left: 0; width: 100%; height: 220px; background: var(--dock-bg); border-top: 1px solid rgba(251, 191, 36, 0.5); display: flex; flex-direction: column; z-index: 10; }
        .dock-col { display: flex; flex-direction: row; align-items: center; justify-content: space-between; flex: 1; padding: 0 28px; border-bottom: 1px solid var(--border); transition: 0.2s; }
        .dock-label { font-size: 0.55rem; font-weight: 900; color: var(--text-sub); width: 70px; flex-shrink: 0; letter-spacing: 1px; }
        .dock-val { font-family: var(--font-book); font-size: 1.1rem; color: var(--text-main); font-weight: 600; text-align: right; flex: 1; }
        .dock-col.active { background: rgba(56, 189, 248, 0.15); border-left: 4px solid var(--accent); }

        #header { width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; border-bottom: 1px solid var(--border); }
        .stat-pill { background: #000; padding: 6px 12px; border-radius: 4px; font-size: 0.7rem; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; color: var(--accent); }
        .progress-line { position: fixed; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.4s; z-index: 100; }

        #analysis-modal { position: fixed; inset: 0; background: #020408; z-index: 5000; display: none; flex-direction: column; padding: 50px 35px; }
        #analysis-modal.open { display: flex; }
        .analysis-block { background: #0b172a; padding: 30px; border-radius: 16px; border-top: 4px solid var(--gold); text-align: left; font-family: var(--font-book); line-height: 1.6; color: #cbd5e1; font-size: 1.25rem; margin-bottom: 30px; }
        .analysis-block b { color: var(--gold); font-weight: 700; }
        .next-step-item { background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border); padding: 18px; border-radius: 12px; font-size: 0.95rem; margin-bottom: 15px; color: var(--accent); }
        .modal-btn { background: var(--accent); color: #020617; border: none; padding: 22px; border-radius: 14px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="session-view">
        <div id="header">
            <div id="meta-label" style="font-size: 0.65rem; color: var(--text-sub); font-weight: 900; letter-spacing: 2px;">ALCHEMIST v167.0</div>
            <div class="stat-pill" id="score-disp">MASTERY: 0%</div>
        </div>
        <div id="stage">
            <div class="card-dock">
                <div class="dock-col" id="col-left"><div class="dock-label">LEFT</div><div class="dock-val" id="val-l">...</div></div>
                <div class="dock-col" id="col-up"><div class="dock-label">UP</div><div class="dock-val" id="val-u">...</div></div>
                <div class="dock-col" id="col-right"><div class="dock-label">RIGHT</div><div class="dock-val" id="val-r">...</div></div>
            </div>
        </div>
        <div class="progress-line" id="progress"></div>
    </div>

    <div id="analysis-modal">
        <div style="flex:1; overflow-y:auto;">
            <div style="font-size: 0.7rem; color: var(--text-sub); font-weight: 800; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase;">Theoretical Framework</div>
            <div class="analysis-block" id="modal-analysis"></div>
            <div style="font-size: 0.7rem; color: var(--text-sub); font-weight: 800; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase;">Research Objectives</div>
            <div id="modal-next"></div>
        </div>
        <button class="modal-btn" onclick="closeModal()">Commit Analysis</button>
    </div>

<script>
/**
 * Alchemist v167.0 
 * Internal Logic Stream
 */
const POOL = [
  {
    "id": "SET_A_001", "rank": "E", "domain": "ANALYTICAL", "goal": "LOD Definitions",
    "question": "In a calibration curve, what is the formal definition of the 'Blank' ($S_{blank}$)?",
    "opt_up": "Signal from a sample with no analyte", "opt_right": "Signal from lowest standard", "opt_left": "Mean of all standards",
    "correct": "UP", "expl_up": "Correct. The blank corrects for background and determines the noise floor.",
    "expl_right": "Incorrect. The lowest standard contains analyte; the blank specifically does not.",
    "expl_left": "Incorrect. This is the mean response, not the baseline.",
    "analysis": "<b>Physical Principle:</b> The <b>Analytical Blank</b> establishes the signal-to-noise floor for $LOD$ ($3\\sigma$) calculations.",
    "next_steps": "1. Calculate $\\sigma_{blank}$. 2. Define LOQ for the dataset."
  }
];

let INDEX = 0, SCORE = 0;

function renderCard() {
    if (INDEX >= POOL.length) { renderEnd(); return; }
    const data = POOL[INDEX];
    
    document.getElementById('meta-label').innerText = data.domain + " | " + data.id;
    document.getElementById('val-u').innerHTML = data.opt_up;
    document.getElementById('val-r').innerHTML = data.opt_right;
    document.getElementById('val-l').innerHTML = data.opt_left;

    const card = document.createElement('div');
    card.className = "card";
    
    var rankClass = (data.rank === 'A') ? "rank-tag rank-a-glow" : "rank-tag";
    card.innerHTML = '<div class="' + rankClass + '">RANK ' + data.rank + '</div>' +
                     '<div class="card-top">' +
                     '<div class="goal-header">' + data.goal + '</div>' +
                     '<div class="card-q" id="q-text">' + data.question + '</div>' +
                     '<div class="card-overlay-text" id="ov-text"></div>' +
                     '</div>';
    
    document.getElementById('stage').appendChild(card);
    bindPhysics(card, data);
}

function bindPhysics(el, data) {
    var startX, startY, isDragging = false;
    var pivotY = window.innerHeight - 220, pivotX = window.innerWidth / 2;
    var qT = el.querySelector('#q-text'), ovT = el.querySelector('#ov-text');
    var cols = { UP: document.getElementById('col-up'), RIGHT: document.getElementById('col-right'), LEFT: document.getElementById('col-left') };

    el.addEventListener('touchstart', function(e) { 
        isDragging = true; startX = e.touches[0].clientX; startY = e.touches[0].clientY; el.style.transition = 'none';
    });

    window.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        var cx = e.touches[0].clientX, cy = e.touches[0].clientY;
        var dist = Math.sqrt(Math.pow(cx - startX, 2) + Math.pow(cy - startY, 2));
        var ang = Math.atan2(cx - pivotX, -(cy - pivotY)) * (180 / Math.PI);
        el.style.transform = 'rotate(' + Math.max(-8, Math.min(8, ang)) + 'deg)';
        var prog = Math.min(Math.max(0, dist - 20) / 80, 1);
        qT.style.opacity = 1 - prog; ovT.style.opacity = prog;
        Object.values(cols).forEach(function(c) { c.classList.remove('active'); });
        var sel = "UP"; if (ang < -15) sel = "LEFT"; else if (ang > 15) sel = "RIGHT";
        cols[sel].classList.add('active');
        ovT.innerHTML = '<span style="font-size:0.8rem; color:var(--gold); display:block; margin-bottom:8px;">HEURISTIC</span>' + data['expl_' + sel.toLowerCase()];
    });

    window.addEventListener('touchend', function(e) {
        if (!isDragging) return; isDragging = false;
        var ex = e.changedTouches[0].clientX, ey = e.changedTouches[0].clientY;
        var total = Math.sqrt(Math.pow(ex - startX, 2) + Math.pow(ey - startY, 2));
        var ang = Math.atan2(ex - pivotX, -(ey - pivotY)) * (180 / Math.PI);
        var threshold = (data.rank === "A") ? 160 : 110;
        if (total > threshold) {
            var dir = "UP"; if (ang < -15) dir = "LEFT"; else if (ang > 15) dir = "RIGHT";
            finishSwipe(el, data, dir);
        } else { resetCard(el); }
    });
}

function finishSwipe(el, data, dir) {
    var isCorrect = (dir === data.correct);
    el.style.transition = 'transform 0.4s ease-in, opacity 0.4s';
    el.style.opacity = '0';
    el.style.transform = 'translate(' + (dir === "UP" ? 0 : (dir === "LEFT" ? -500 : 500)) + 'px, ' + (dir === "UP" ? -500 : 0) + 'px)';
    if(isCorrect) SCORE++;
    document.getElementById('score-disp').innerText = "MASTERY: " + Math.round((SCORE/(INDEX+1))*100) + "%";
    document.getElementById('progress').style.width = ((INDEX+1)/POOL.length)*100 + "%";
    setTimeout(function() { showAnalysis(data); el.remove(); }, 300);
}

function showAnalysis(data) {
    document.getElementById('modal-analysis').innerHTML = data.analysis;
    var stepsArr = data.next_steps.split('. ');
    var stepsHTML = "";
    for(var i=0; i<stepsArr.length; i++) { stepsHTML += '<div class="next-step-item">' + stepsArr[i] + '</div>'; }
    document.getElementById('modal-next').innerHTML = stepsHTML;
    document.getElementById('analysis-modal').classList.add('open');
}

function closeModal() { document.getElementById('analysis-modal').classList.remove('open'); INDEX++; renderCard(); }
function resetCard(el) { el.style.transition = '0.3s ease'; el.style.transform = 'rotate(0deg)'; el.querySelector('#q-text').style.opacity = 1; el.querySelector('#ov-text').style.opacity = 0; }
function renderEnd() { document.getElementById('stage').innerHTML = '<div class="card" style="justify-content:center; align-items:center;"><div class="card-q">CALIBRATION COMPLETE</div><button class="modal-btn" onclick="location.reload()" style="width:80%; margin-top:30px;">RESTART</button></div>'; }

renderCard();
</script>
</body>
</html>
