<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALCHEMIST | VERTICAL MASTER</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #05080f; --card-bg: #0b172a; --dock-bg: #0e1b2e; 
            --border: #1e2f4a; --accent: #38bdf8; --text-main: #f0f4f8; 
            --text-sub: #64748b; --green: #4ade80; --red: #f87171; 
            --font-ui: 'Inter', sans-serif; --font-book: 'Crimson Pro', serif;       
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; height: 100vh; background: var(--bg); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; display: flex; flex-direction: column; }

        /* PORTAL */
        #portal { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; }
        .portal-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .app-title { font-size: 1.2rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .section-label { font-size: 0.7rem; color: var(--text-sub); margin: 25px 0 10px; text-transform: uppercase; display: block; font-weight: 600; }
        #library { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .topic-tile { background: var(--card-bg); border: 1px solid var(--border); padding: 16px; border-radius: 12px; transition: 0.2s; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .topic-tile:active { transform: scale(0.98); background: var(--dock-bg); }
        .topic-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
        .topic-meta { color: var(--accent); font-size: 0.7rem; font-family: var(--font-code); }
        textarea { width: 100%; height: 80px; background: #0f1623; border: 1px solid var(--border); color: var(--accent); font-family: var(--font-code); padding: 12px; border-radius: 8px; font-size: 0.7rem; margin-bottom: 10px; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; background: #fff; color: #000; font-weight: 700; text-transform: uppercase; cursor: pointer; font-size: 0.75rem; letter-spacing: 1px; margin-bottom: 8px; }
        .btn-blue { background: var(--accent); color: #000; }
        .btn-dark { background: var(--dock-bg); color: var(--text-sub); border: 1px solid var(--border); }

        /* SESSION */
        #session-view { display: none; flex-direction: column; height: 100vh; position: relative; }
        #header { width: 100%; height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; z-index: 1000; background: transparent; }
        .nav-back { font-size: 0.75rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .stat-pill { background: rgba(11,23,42,0.8); padding: 8px 16px; border-radius: 6px; font-size: 0.75rem; border: 1px solid var(--border); font-weight: 700; letter-spacing: 1px; font-family: var(--font-code); }

        /* STAGE */
        #stage { flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: visible; position: relative; perspective: 1000px; }

        /* CARD */
        .card { 
            position: absolute; width: 92%; max-width: 380px; height: 75vh; max-height: 650px;
            background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); 
            display: flex; flex-direction: column; 
            box-shadow: 0 30px 60px -10px rgba(0,0,0,0.6); 
            /* ORIGIN: 50% X, 150% Y (Screen bottom pivot) */
            transform-origin: 50% 150vh; 
            will-change: transform; overflow: hidden;
        }

        .card-top { flex-grow: 1; padding: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; transition: opacity 0.2s; }
        .card-q { font-family: var(--font-book); font-size: clamp(1.6rem, 5vmin, 2.2rem); font-weight: 600; line-height: 1.3; color: #fff; }
        .card-overlay-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; font-weight: 800; color: #fff; opacity: 0; pointer-events: none; width: 90%; text-align: center; text-shadow: 0 10px 30px rgba(0,0,0,0.8); font-family: var(--font-ui); transition: opacity 0.1s; }

        /* --- VERTICAL DOCK STACK --- */
        .card-dock { 
            min-height: 200px; /* Consumes space */
            background: var(--dock-bg); 
            border-top: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; /* VERTICAL */
            justify-content: center;
            flex-shrink: 0;
            padding: 5px 0;
        }
        
        .dock-col { 
            display: flex; 
            flex-direction: row; /* Horizontal Layout within row */
            align-items: center; 
            justify-content: space-between;
            flex: 1; 
            padding: 0 24px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            transition: background 0.2s;
        }
        .dock-col:last-child { border-bottom: none; }
        
        .dock-label { 
            font-size: 0.65rem; font-weight: 800; color: var(--text-sub); 
            letter-spacing: 1px; text-transform: uppercase; 
            width: 80px; flex-shrink: 0;
            display: flex; align-items: center; gap: 6px;
        }
        
        .dock-val { 
            font-family: var(--font-book); font-size: 1.1rem; color: var(--text-main); font-weight: 500; 
            opacity: 0.8; text-align: right; line-height: 1.2; 
        }
        
        .dock-col.active { background: rgba(56, 189, 248, 0.15); }
        .dock-col.active .dock-val { color: var(--accent); opacity: 1; }

        .card-dummy { position: absolute; width: 85%; height: 60vh; background: #08101e; border-radius: 20px; z-index: -1; opacity: 0.5; bottom: 15%; }

        /* MODAL */
        #analysis-modal { position: fixed; inset: 0; background: rgba(5,8,15,0.98); z-index: 5000; display: none; flex-direction: column; padding: 30px; opacity: 0; transition: opacity 0.25s ease; }
        #analysis-modal.open { display: flex; opacity: 1; }
        .modal-content { flex: 1; display: flex; flex-direction: column; justify-content: center; color: #cbd5e1; line-height: 1.8; font-size: 1.2rem; font-family: var(--font-book); }
        .progress-line { position: fixed; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.4s; }
    </style>
</head>
<body>

    <div id="portal">
        <div class="portal-header"><div class="app-title">Alchemist V143</div></div>
        <div id="library"></div>
        <div style="margin-top:auto;">
            <div class="section-label">System Tools</div>
            <textarea id="data-input" placeholder="Paste TSV Data..."></textarea>
            <button class="btn btn-blue" onclick="importDataset()">Import Data</button>
            <button class="btn btn-dark" onclick="clearLibrary()">Reset System</button>
        </div>
    </div>

    <div id="session-view">
        <div id="header">
            <div class="nav-back" onclick="exitSession()">← Library</div>
            <div class="stat-pill" id="score-disp">0% ACCURACY</div>
        </div>
        <div id="stage">
            <div class="card-dummy"></div>
            </div>
        <div class="progress-line" id="progress"></div>
    </div>

    <div id="analysis-modal">
        <div class="modal-content" id="modal-text"></div>
        <button class="btn btn-blue" onclick="closeModal()">CONTINUE</button>
    </div>

<script>
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyUrjUy8jL3jrJ8k3yIjEdFbFHtoyfbR7PRXAjnUzbopTOELvGT-MQXw7pApmOeahuyoA/exec";
    const SESSION_ID = "SESS_" + Date.now().toString().slice(-5);
    let db, INDEX = 0, SCORE = 0, POOL = [];
    const DB_NAME = "AlchemistDB_V143", STORE_NAME = "Vaults";

    const DEMO_DATA = [
        {id:"FAC_01", set:"FACULTY_DEMO", dom:"THERMO", q:"Relationship between Kp and Kc for N2 + 3H2 <=> 2NH3?", u:"Kp = Kc(RT)", r:"Kp = Kc(RT)^-2", l:"Kp = Kc(RT)^2", ans:"RIGHT", expl:"Delta n = -2. Thus Kp = Kc(RT)^-2."},
        {id:"FAC_02", set:"FACULTY_DEMO", dom:"KINETIC", q:"If Ea = 50 kJ/mol, rate increase from 300K to 310K?", u:"1.5x", r:"~2.0x", l:"3.0x", ans:"RIGHT", expl:"Using Arrhenius eq, ln(k2/k1) approx 0.693."},
        {id:"FAC_03", set:"FACULTY_DEMO", dom:"QUANTUM", q:"Energy of 1D box particle in 2nd excited state (n=3)?", u:"h^2/8mL^2", r:"9h^2/8mL^2", l:"4h^2/8mL^2", ans:"RIGHT", expl:"E scales with n^2. 2nd excited is n=3. 3^2=9."}
    ];

    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; db.createObjectStore(STORE_NAME); };
    request.onsuccess = e => { 
        db = e.target.result; 
        const tx = db.transaction([STORE_NAME], "readonly");
        const count = tx.objectStore(STORE_NAME).count();
        count.onsuccess = () => {
            if(count.result === 0) {
                const wTx = db.transaction([STORE_NAME], "readwrite");
                wTx.objectStore(STORE_NAME).put(DEMO_DATA, "FACULTY_DEMO");
                wTx.oncomplete = refreshLibrary;
            } else refreshLibrary();
        }
    };

    function refreshLibrary() {
        const container = document.getElementById('library'); container.innerHTML = "";
        db.transaction([STORE_NAME], "readonly").objectStore(STORE_NAME).openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                const div = document.createElement('div');
                div.className = "topic-tile";
                div.onclick = () => startSession(cursor.key);
                div.innerHTML = `<span class="topic-name">${cursor.key}</span><span class="topic-meta">${cursor.value.length} CARDS</span>`;
                container.appendChild(div);
                cursor.continue();
            }
        };
    }

    function formatText(t) {
        if(!t) return "";
        t = t.replace(/\bKp\b/g, '<i>K</i><sub>p</sub>').replace(/\bKc\b/g, '<i>K</i><sub>c</sub>').replace(/\bDelta\b/g, 'Δ');
        t = t.replace(/<=>/g, '⇌').replace(/->/g, '→').replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>').replace(/\^(\-?\d+)/g, '<sup>$1</sup>');
        return t;
    }

    function startSession(key) {
        db.transaction([STORE_NAME], "readonly").objectStore(STORE_NAME).get(key).onsuccess = e => {
            let data = e.target.result;
            POOL = [...data];
            for (let i = POOL.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [POOL[i], POOL[j]] = [POOL[j], POOL[i]]; }
            INDEX = 0; SCORE = 0;
            document.getElementById('portal').style.display = 'none';
            document.getElementById('session-view').style.display = 'flex';
            renderCard();
            logData("INIT", "START", key, "");
        };
    }

    function exitSession() {
        document.getElementById('session-view').style.display = 'none';
        document.getElementById('portal').style.display = 'flex';
    }

    function renderCard() {
        if (INDEX >= POOL.length) { renderEnd(); return; }
        const q = POOL[INDEX];
        const opts = [
            { txt: q.u, isCorrect: q.ans === "UP", dir: "UP" },
            { txt: q.r, isCorrect: q.ans === "RIGHT", dir: "RIGHT" },
            { txt: q.l, isCorrect: q.ans === "LEFT", dir: "LEFT" }
        ].sort(() => Math.random() - 0.5);

        q.u_txt = opts[0].txt; q.u_chk = opts[0].isCorrect;
        q.r_txt = opts[1].txt; q.r_chk = opts[1].isCorrect;
        q.l_txt = opts[2].txt; q.l_chk = opts[2].isCorrect;
        q.actualAns = q.u_chk ? "UP" : (q.r_chk ? "RIGHT" : "LEFT");

        const card = document.createElement('div');
        card.className = "card";
        card.id = "active-card";
        
        card.innerHTML = `
            <div class="card-top">
                <div class="card-q" id="q-text">${formatText(q.q)}</div>
                <div class="card-overlay-text" id="ov-text"></div>
            </div>
            
            <div class="card-dock">
                <div class="dock-col" id="col-left">
                    <div class="dock-label">← LEFT</div>
                    <div class="dock-val">${formatText(q.l_txt)}</div>
                </div>
                <div class="dock-col" id="col-up">
                    <div class="dock-label">↑ UP</div>
                    <div class="dock-val">${formatText(q.u_txt)}</div>
                </div>
                <div class="dock-col" id="col-right">
                    <div class="dock-label">RIGHT →</div>
                    <div class="dock-val">${formatText(q.r_txt)}</div>
                </div>
            </div>
        `;
        document.getElementById('stage').appendChild(card);
        bindPhysics(card, q);
    }

    function bindPhysics(el, data) {
        let startX, startY, isDragging = false;
        
        // Pivot Point: Bottom Center Screen
        const pivotX = window.innerWidth / 2;
        const pivotY = window.innerHeight;

        const qText = el.querySelector('#q-text');
        const ovText = el.querySelector('#ov-text');
        const colLeft = el.querySelector('#col-left');
        const colRight = el.querySelector('#col-right');
        const colUp = el.querySelector('#col-up');

        el.addEventListener('touchstart', e => { isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; el.style.transition='none'; });
        
        window.addEventListener('touchmove', e => {
            if (!isDragging) return;
            const cx = e.touches[0].clientX; 
            const cy = e.touches[0].clientY;
            
            // Vector Calc
            const dx = cx - pivotX;
            const dy = cy - pivotY;
            let angleDeg = Math.atan2(dx, -dy) * (180 / Math.PI);
            
            // V-Clamp: +/- 10 degrees
            let rot = angleDeg;
            if (rot > 10) rot = 10;
            if (rot < -10) rot = -10;

            const dragX = cx - startX;
            const dragY = cy - startY;

            el.style.transform = `translate(${dragX}px, ${dragY}px) rotate(${rot}deg)`;
            
            // Fade & Highlight
            const dist = Math.sqrt(dragX*dragX + dragY*dragY);
            const intensity = Math.min(dist / 150, 1);
            
            qText.style.opacity = Math.max(0, 1 - (intensity * 2));
            ovText.style.opacity = intensity;
            
            [colLeft, colRight, colUp].forEach(c => c.classList.remove('active'));

            if (dragY < -50 && Math.abs(angleDeg) < 15) {
                ovText.innerHTML = formatText(data.u_txt);
                colUp.classList.add('active');
            } else if (dragX > 50) {
                ovText.innerHTML = formatText(data.r_txt);
                colRight.classList.add('active');
            } else if (dragX < -50) {
                ovText.innerHTML = formatText(data.l_txt);
                colLeft.classList.add('active');
            }
        });

        window.addEventListener('touchend', e => {
            if (!isDragging) return; isDragging=false;
            const x = e.changedTouches[0].clientX - startX;
            const y = e.changedTouches[0].clientY - startY;
            
            const dx = e.changedTouches[0].clientX - pivotX;
            const dy = e.changedTouches[0].clientY - pivotY;
            let angleDeg = Math.atan2(dx, -dy) * (180 / Math.PI);

            if (Math.abs(x) > 80 || y < -80) {
                if (y < -80 && Math.abs(angleDeg) < 20) finishSwipe(el, data, "UP");
                else if (x > 80) finishSwipe(el, data, "RIGHT");
                else if (x < -80) finishSwipe(el, data, "LEFT");
                else resetCard(el);
            } else resetCard(el);
        });
    }

    function resetCard(el) { 
        el.style.transition='transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'; 
        el.style.transform='translate(0,0) rotate(0deg)'; 
        el.querySelector('#q-text').style.opacity = 1;
        el.querySelector('#ov-text').style.opacity = 0;
        el.querySelectorAll('.dock-col').forEach(c => c.classList.remove('active'));
    }

    function finishSwipe(el, data, dir) {
        let tx = dir === "RIGHT" ? window.innerWidth : (dir === "LEFT" ? -window.innerWidth : 0);
        let ty = dir === "UP" ? -window.innerHeight : 0;
        let rot = dir === "RIGHT" ? 20 : (dir === "LEFT" ? -20 : 0);
        el.style.transition='transform 0.4s ease-in'; 
        el.style.transform=`translate(${tx}px, ${ty}px) rotate(${rot}deg)`;

        const corr = (dir===data.actualAns); SCORE += corr?1:0; 
        logData(data.id, dir, corr?"CORRECT":"WRONG", "");
        setTimeout(()=>{el.remove(); INDEX++; renderCard();}, 300);
    }

    function closeModal() { document.getElementById('analysis-modal').classList.remove('open'); }
    function logData(qid, act, res, conc) { if(BACKEND_URL) fetch(BACKEND_URL, { method:"POST", mode:"no-cors", headers:{"Content-Type":"application/json"}, body:JSON.stringify({session_id:SESSION_ID, question_id:qid, action:act, result:res, device:navigator.platform, conclusion:conc}) }); }

    function renderEnd() {
        let pct = Math.round((SCORE/POOL.length)*100);
        document.getElementById('stage').innerHTML = `<div class="card" style="justify-content:center; align-items:center;"><div style="color:var(--accent);font-size:3rem;">✓</div><div class="card-q">SESSION COMPLETE</div><h2 style="color:#fff;">${pct}% ACCURACY</h2><button class="btn btn-blue" onclick="exitSession()" style="width:80%; margin-top:20px;">RETURN TO LIBRARY</button></div>`;
    }

    async function importDataset() { 
        const r=document.getElementById('data-input').value.trim(); if(!r)return; 
        const l=r.split(/\r?\n/); let p=[]; 
        for(let i=0;i<l.length;i++){ let c=l[i].split(/\t/); if(c.length>=8 && c[0]!=="ID") p.push({id:c[0], set:c[1], dom:c[2], q:c[4], u:c[5], r:c[6], l:c[7], ans:c[8], expl:c[9]||""}); }
        if(p.length){ const tx = db.transaction([STORE_NAME],"readwrite"); tx.objectStore(STORE_NAME).put(p, p[0].set); tx.oncomplete = () => { alert("Imported!"); document.getElementById('data-input').value=""; refreshLibrary(); } }
    }
    function clearLibrary() { if(confirm("Reset Everything?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } }
</script>
</body>
</html>
