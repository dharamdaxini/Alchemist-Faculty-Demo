<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ALCHEMIST | V158 STABLE</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS STYLES --- */
        :root { 
            --bg: #05080f; --card-bg: #0b172a; --dock-bg: #0f203a; 
            --border: #1e2f4a; --accent: #38bdf8; --text-main: #f0f4f8; 
            --text-sub: #64748b; --green: #4ade80; --red: #f87171; --gold: #fbbf24;
            --font-ui: 'Inter', sans-serif; --font-book: 'Crimson Pro', serif;       
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; height: 100vh; background: var(--bg); color: var(--text-main); font-family: var(--font-ui); overflow: hidden; display: flex; flex-direction: column; }

        /* PORTAL VIEW */
        #portal { flex: 1; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; }
        .portal-header { text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .app-title { font-size: 1.2rem; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .section-label { font-size: 0.7rem; color: var(--text-sub); margin: 25px 0 10px; text-transform: uppercase; display: block; font-weight: 600; }
        #library { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 30px; }
        .topic-tile { background: var(--card-bg); border: 1px solid var(--border); padding: 16px; border-radius: 12px; transition: 0.2s; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .topic-tile:active { transform: scale(0.98); background: var(--dock-bg); }
        .topic-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
        .topic-meta { color: var(--accent); font-size: 0.7rem; font-family: var(--font-code); }
        textarea { width: 100%; height: 80px; background: #0f1623; border: 1px solid var(--border); color: var(--accent); font-family: var(--font-code); padding: 12px; border-radius: 8px; font-size: 0.7rem; margin-bottom: 10px; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; background: #fff; color: #000; font-weight: 700; text-transform: uppercase; cursor: pointer; font-size: 0.75rem; letter-spacing: 1px; margin-bottom: 8px; }
        .btn-blue { background: var(--accent); color: #000; }
        .btn-dark { background: var(--dock-bg); color: var(--text-sub); border: 1px solid var(--border); }

        /* SESSION VIEW */
        #session-view { display: none; flex-direction: column; height: 100vh; position: relative; }
        #header { width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 24px; z-index: 1000; background: transparent; }
        .nav-back { font-size: 0.75rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; cursor: pointer; }
        .stat-pill { background: rgba(11, 23, 42, 0.8); padding: 8px 16px; border-radius: 6px; font-size: 0.75rem; border: 1px solid var(--border); font-weight: 700; letter-spacing: 1px; font-family: var(--font-code); }

        /* STAGE & ANCHORING */
        #stage { 
            flex-grow: 1; 
            position: relative; 
            overflow: hidden; 
            perspective: 1000px; 
        }

        /* CARD (ANCHORED TO DOCK) */
        .card { 
            position: absolute; 
            left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 380px; 
            
            /* VISUAL ANCHOR: Sits exactly on the Yellow Line */
            bottom: 220px; 
            top: 70px;
            
            background: var(--card-bg); 
            border-radius: 20px 20px 0 0; 
            border: 1px solid var(--border); border-bottom: none;
            
            display: flex; flex-direction: column; 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
            
            /* PIVOT: BOTTOM CENTER */
            transform-origin: 50% 100%; 
            will-change: transform; overflow: hidden;
        }

        .card-top { flex-grow: 1; padding: 24px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; }
        
        /* Text Transitions */
        .card-q { 
            font-family: var(--font-book); font-size: clamp(1.6rem, 5vmin, 2.2rem); 
            font-weight: 600; line-height: 1.3; color: #fff; 
            transition: opacity 0.05s linear; /* Smooth Cross-Fade */
        }
        
        .card-overlay-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-family: var(--font-book); font-size: 2rem; font-weight: 600; color: #fff; 
            opacity: 0; pointer-events: none; width: 90%; text-align: center; 
            text-shadow: 0 10px 30px rgba(0,0,0,0.9); 
            transition: opacity 0.05s linear;
        }

        /* DOCK (THE ANCHOR BASE) */
        .card-dock { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 220px; background: var(--dock-bg); 
            border-top: 2px solid var(--gold); /* YELLOW LINE */
            display: flex; flex-direction: column; justify-content: center; 
            padding: 10px 0; transition: background 0.2s; z-index: 10;
        }
        .card-dock.analysis-mode { background: rgba(251, 191, 36, 0.1); }

        .dock-col { 
            display: flex; flex-direction: row; align-items: center; justify-content: space-between;
            flex: 1; padding: 8px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s;
        }
        .dock-col:last-child { border-bottom: none; }
        .dock-label { font-size: 0.6rem; font-weight: 800; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; width: 60px; flex-shrink: 0; text-align: left; }
        .dock-val { font-family: var(--font-book); font-size: 1.1rem; color: var(--text-main); font-weight: 600; opacity: 0.8; text-align: right; line-height: 1.3; flex: 1; padding-left: 12px; white-space: normal; word-break: break-word; }
        
        .dock-col.active { background: rgba(56, 189, 248, 0.1); }
        .dock-col.active .dock-val { color: var(--accent); opacity: 1; }

        .card-dummy { position: absolute; width: 85%; height: 60vh; background: #08101e; border-radius: 20px; z-index: -1; opacity: 0.5; bottom: 230px; left: 50%; transform: translateX(-50%); }

        /* MODAL */
        #analysis-modal { position: fixed; inset: 0; background: rgba(5,8,15,0.98); z-index: 5000; display: none; flex-direction: column; padding: 30px; opacity: 0; transition: opacity 0.25s ease; }
        #analysis-modal.open { display: flex; opacity: 1; }
        .modal-content { flex: 1; display: flex; flex-direction: column; justify-content: center; color: #cbd5e1; line-height: 1.8; font-size: 1.2rem; font-family: var(--font-book); }
        .modal-btn { background: var(--accent); color: #050505; border: none; padding: 18px; border-radius: 8px; font-weight: 700; font-size: 0.85rem; margin-top: 20px; text-transform: uppercase; letter-spacing: 1.5px; font-family: var(--font-ui); }
        .progress-line { position: fixed; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.4s; z-index: 100; }
    </style>
</head>
<body>

    <div id="portal">
        <div class="portal-header"><div class="app-title">Alchemist</div><div class="section-label">V158 Stable</div></div>
        <div id="library"></div>
        <div style="margin-top:auto;">
            <div class="section-label">System Tools</div>
            <textarea id="data-input" placeholder="Paste TSV Data..."></textarea>
            <button class="btn btn-blue" onclick="importDataset()">Import Data</button>
            <button class="btn btn-dark" onclick="clearLibrary()">Reset System</button>
        </div>
    </div>

    <div id="session-view">
        <div id="header">
            <div class="nav-back" onclick="exitSession()">← Library</div>
            <div class="stat-pill" id="score-disp">0% ACCURACY</div>
        </div>
        <div id="stage">
            <div class="card-dummy"></div>
            <div class="card-dock" id="card-dock">
                <div class="dock-col" id="col-left"><div class="dock-label">← LEFT</div><div class="dock-val">...</div></div>
                <div class="dock-col" id="col-up"><div class="dock-label">↑ UP</div><div class="dock-val">...</div></div>
                <div class="dock-col" id="col-right"><div class="dock-label">RIGHT →</div><div class="dock-val">...</div></div>
            </div>
        </div>
        <div class="progress-line" id="progress"></div>
    </div>

    <div id="analysis-modal">
        <div class="modal-content" id="modal-text"></div>
        <button class="modal-btn" onclick="closeModal()">CONTINUE</button>
    </div>

<script>
    // --- JS LOGIC ---
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyUrjUy8jL3jrJ8k3yIjEdFbFHtoyfbR7PRXAjnUzbopTOELvGT-MQXw7pApmOeahuyoA/exec";
    const SESSION_ID = "SESS_" + Date.now().toString().slice(-5);
    let db, INDEX = 0, SCORE = 0, POOL = [];
    const DB_NAME = "AlchemistDB_V158", STORE_NAME = "Vaults";

    // 30 Question Dataset
    const DEMO_DATA = [
        {id:"FAC_01", dom:"THERMO", q:"Relationship between Kp and Kc for: N2 + 3H2 <=> 2NH3?", u:"Kp = Kc(RT)", l:"Kp = Kc(RT)^2", r:"Kp = Kc(RT)^-2", ans:"RIGHT", expl:"Delta n = 2-4 = -2. Thus Kp = Kc(RT)^-2."},
        {id:"FAC_02", dom:"KINETIC", q:"If Ea = 50 kJ/mol, by what factor does rate increase from 300K to 310K?", u:"~1.5x", l:"~3.0x", r:"~2.0x", ans:"RIGHT", expl:"Using Arrhenius eq, ln(k2/k1) ≈ 0.693, meaning the rate doubles."},
        {id:"FAC_03", dom:"QUANTUM", q:"Energy of a particle in a 1D box in the second excited state (n=3)?", u:"h^2 / 8mL^2", l:"4h^2 / 8mL^2", r:"9h^2 / 8mL^2", ans:"RIGHT", expl:"Energy scales with n^2. Ground=1, 1st=2, 2nd=3. 3^2 = 9."},
        {id:"FAC_04", dom:"ANALYT", q:"In HPLC, if tR = 5 min and w = 0.5 min, calculate theoretical plates (N).", u:"1600", l:"100", r:"1600", ans:"RIGHT", expl:"N = 16 * (tR / w)^2 = 16 * (5 / 0.5)^2 = 16 * 100 = 1600."},
        {id:"FAC_05", dom:"INORG", q:"Calculate CFSE for a d6 high-spin octahedral complex.", u:"-2.4 Do", l:"0 Do", r:"-0.4 Do", ans:"RIGHT", expl:"High spin d6 is t2g(4) eg(2). CFSE = 4(-0.4) + 2(0.6) = -0.4."},
        {id:"FAC_06", dom:"ORGANIC", q:"How many 1H NMR signals are in 1,2-dichloroethane?", u:"2 Signals", l:"4 Signals", r:"1 Signal", ans:"RIGHT", expl:"Due to symmetry, all 4 protons are chemically and magnetically equivalent."},
        {id:"FAC_07", dom:"THERMO", q:"Ionic strength (I) of 0.1 M Na2SO4 solution?", u:"0.1 M", l:"0.2 M", r:"0.3 M", ans:"RIGHT", expl:"I = 0.5 * sum(ci * zi^2) = 0.5 * (0.2*1^2 + 0.1*2^2) = 0.3 M."},
        {id:"FAC_08", dom:"QUANTUM", q:"Uncertainty in velocity if Delta x = 1.0 A for an electron?", u:"5.8e5 m/s", l:"1.0e6 m/s", r:"5.8e5 m/s", ans:"RIGHT", expl:"Delta v = h / (4pi * m * Delta x). Calculation yields ~5.8e5 m/s."},
        {id:"FAC_09", dom:"ANALYT", q:"Peak separation (Delta Ep) for a reversible 1-electron CV transfer?", u:"29 mV", l:"0 mV", r:"59 mV", ans:"RIGHT", expl:"For a reversible Nernstian couple, Delta Ep = 59/n mV at 25C."},
        {id:"FAC_10", dom:"INORG", q:"Spin-only magnetic moment for Co2+ (d7) in tetrahedral field?", u:"1.73 BM", l:"4.90 BM", r:"3.87 BM", ans:"RIGHT", expl:"Tetrahedral is High Spin (e4 t2 3). 3 unpaired e-. sqrt(3*5) = 3.87 BM."},
        {id:"FAC_11", dom:"ORGANIC", q:"Degree of unsaturation (DoU) for C6H10O?", u:"1", l:"3", r:"2", ans:"RIGHT", expl:"DoU = C + 1 - H/2 = 6 + 1 - 5 = 2. (Could be 2 rings, 2 pi bonds)."},
        {id:"FAC_12", dom:"KINETIC", q:"For 2nd order (A->P), t=20min for 1.0M to 0.5M. Time to drop 0.5M to 0.25M?", u:"20 min", l:"60 min", r:"40 min", ans:"RIGHT", expl:"In 2nd order, half-life doubles as concentration halves. 20 * 2 = 40 min."},
        {id:"FAC_13", dom:"STATMEC", q:"Rotational partition function (qr) for heteronuclear diatomic at high T?", u:"kT / hB", l:"kT / 2hcB", r:"kT / hcB", ans:"RIGHT", expl:"For sigma=1 (heteronuclear), qr = kT / hcB."},
        {id:"FAC_14", dom:"INORG", q:"Why is 'Trans Influence' strong for high pi-acidity ligands?", u:"Donates e-", l:"Steric", r:"Orbital Competition", ans:"RIGHT", expl:"They withdraw density from the same metal d-orbitals used by the trans ligand, weakening its bond."},
        {id:"FAC_15", dom:"ORGANIC", q:"In 'Robinson Annulation', what are the two sequential reactions?", u:"Aldol + Wittig", l:"Michael + Claisen", r:"Michael + Aldol", ans:"RIGHT", expl:"It begins with a Michael addition followed by an intramolecular Aldol condensation."},
        {id:"FAC_16", dom:"QUANTUM", q:"Physical origin of 'Exchange Energy' in multi-electron systems?", u:"Coulomb", l:"Gravity", r:"Pauli + Coulomb", ans:"RIGHT", expl:"Antisymmetry keeps same-spin electrons apart (Fermi Hole), reducing their Coulomb repulsion."},
        {id:"FAC_17", dom:"ANALYT", q:"Why use 'Internal Standard' in quantitative GC?", u:"Clean syringe", l:"Lower BP", r:"Ratio correction", ans:"RIGHT", expl:"It compensates for human error in injection volume or instrument drift."},
        {id:"FAC_18", dom:"THERMO", q:"What implies a 'Negative' Volume of Activation (Delta V++)?", u:"Slower at high P", l:"No change", r:"Faster at high P", ans:"RIGHT", expl:"Negative means the Transition State is more compact, so Pressure accelerates it."},
        {id:"FAC_19", dom:"INORG", q:"Why 'Inverse' Spinel for Fe3O4?", u:"Lattice Energy", l:"Size mismatch", r:"Site Preference", ans:"RIGHT", expl:"Fe(III) is d5 (0 CFSE). Fe(II) is d6 and gains stability in the octahedral B-site."},
        {id:"FAC_20", dom:"ORGANIC", q:"'Endo' selectivity in Diels-Alder is due to?", u:"Sterics", l:"Entropy", r:"Pi-Overlap", ans:"RIGHT", expl:"Overlap between the pi-system of the substituent and the diene stabilizes the endo TS."},
        {id:"FAC_21", dom:"KINETIC", q:"'Steady-State Approximation' implies?", u:"Conc = 0", l:"Time = infinity", r:"Rate form = Rate loss", ans:"RIGHT", expl:"It assumes d[I]/dt = 0 for highly reactive intermediates."},
        {id:"FAC_22", dom:"ANALYT", q:"Why use 'Deuterated' solvent in NMR?", u:"Solubility", l:"Cooling", r:"Invisible Solvent", ans:"RIGHT", expl:"Deuterium resonates at a different frequency, making the solvent 'invisible' in 1H NMR."},
        {id:"FAC_23", dom:"LAB", q:"Primary risk of heating a 'Closed System'?", u:"Solvent loss", l:"Slow rxn", r:"Explosion", ans:"RIGHT", expl:"PV=nRT. increasing T in fixed V causes massive P increase -> Explosion."},
        {id:"FAC_24", dom:"LAB", q:"Why 'Acid to Water' during dilution?", u:"Mixing", l:"Speed", r:"Heat Safety", ans:"RIGHT", expl:"High heat capacity of water absorbs the exothermic energy safely."},
        {id:"FAC_25", dom:"LAB", q:"Function of 'Boric Acid' in Kjeldahl method?", u:"Digest", l:"Catalyst", r:"Trap Ammonia", ans:"RIGHT", expl:"Ammonia distilled is captured in boric acid to form ammonium borate for titration."},
        {id:"FAC_26", dom:"QUANTUM", q:"'Born-Oppenheimer' approx fails when?", u:"High Mass", l:"Relativistic", r:"Surfaces Touch", ans:"RIGHT", expl:"When energy gap vanishes (Conical Intersection), nuclear and electronic timescales mix."},
        {id:"FAC_27", dom:"THERMO", q:"'Critical Opalescence' is caused by?", u:"Solidification", l:"Absorption", r:"Density Fluctuation", ans:"RIGHT", expl:"Near critical point, density fluctuations match light wavelength -> scattering."},
        {id:"FAC_28", dom:"INORG", q:"'Jahn-Teller' distortion in d9 octahedral?", u:"Symmetry Up", l:"Sterics", r:"Lower Energy", ans:"RIGHT", expl:"Distorting splits the degenerate levels, putting the odd electron in a lower energy orbital."},
        {id:"FAC_29", dom:"ORGANIC", q:"'Favorskii' rearrangement mechanism?", u:"Radical", l:"Carbocation", r:"Cyclopropanone", ans:"RIGHT", expl:"Base removes alpha-H, forming a cyclopropanone intermediate via internal SN2."},
        {id:"FAC_30", dom:"STATMEC", q:"'Ergodicity' means?", u:"Entropy", l:"Chaos", r:"Time = Ensemble", ans:"RIGHT", expl:"The system visits all possible states over time, so one trace represents the whole group."}
    ];

    const request = indexedDB.open(DB_NAME, 1);
    request.onupgradeneeded = e => { db = e.target.result; db.createObjectStore(STORE_NAME); };
    request.onsuccess = e => { 
        db = e.target.result; 
        const tx = db.transaction([STORE_NAME], "readonly");
        const count = tx.objectStore(STORE_NAME).count();
        count.onsuccess = () => {
            const wTx = db.transaction([STORE_NAME], "readwrite");
            wTx.objectStore(STORE_NAME).put(DEMO_DATA, "FACULTY_DEMO");
            wTx.oncomplete = refreshLibrary;
        }
    };

    function refreshLibrary() {
        const container = document.getElementById('library'); container.innerHTML = "";
        db.transaction([STORE_NAME], "readonly").objectStore(STORE_NAME).openCursor().onsuccess = e => {
            const cursor = e.target.result;
            if (cursor) {
                const div = document.createElement('div');
                div.className = "topic-tile";
                div.onclick = () => startSession(cursor.key);
                div.innerHTML = `<span class="topic-name">${cursor.key}</span><span class="topic-meta">${cursor.value.length} CARDS</span>`;
                container.appendChild(div);
                cursor.continue();
            }
        };
    }

    function formatText(t) {
        if(!t) return "";
        t = t.replace(/\bKp\b/g, '<i>K</i><sub>p</sub>').replace(/\bKc\b/g, '<i>K</i><sub>c</sub>').replace(/\bDelta\b/g, 'Δ');
        t = t.replace(/<=>/g, '⇌').replace(/->/g, '→').replace(/([A-Z][a-z]?)(\d+)/g, '$1<sub>$2</sub>').replace(/\^(\-?\d+)/g, '<sup>$1</sup>');
        return t;
    }

    function startSession(key) {
        db.transaction([STORE_NAME], "readonly").objectStore(STORE_NAME).get(key).onsuccess = e => {
            let data = e.target.result;
            POOL = [...data];
            for (let i = POOL.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [POOL[i], POOL[j]] = [POOL[j], POOL[i]]; }
            INDEX = 0; SCORE = 0;
            document.getElementById('portal').style.display = 'none';
            document.getElementById('session-view').style.display = 'flex';
            renderCard();
            logData("INIT", "START", key, "");
        };
    }

    function exitSession() {
        document.getElementById('session-view').style.display = 'none';
        document.getElementById('portal').style.display = 'flex';
    }

    function renderCard() {
        if (INDEX >= POOL.length) { renderEnd(); return; }
        const q = POOL[INDEX];
        const opts = [
            { txt: q.u, isCorrect: q.ans === "UP", dir: "UP" },
            { txt: q.r, isCorrect: q.ans === "RIGHT", dir: "RIGHT" },
            { txt: q.l, isCorrect: q.ans === "LEFT", dir: "LEFT" }
        ].sort(() => Math.random() - 0.5);

        q.u_txt = opts[0].txt; q.u_chk = opts[0].isCorrect;
        q.r_txt = opts[1].txt; q.r_chk = opts[1].isCorrect;
        q.l_txt = opts[2].txt; q.l_chk = opts[2].isCorrect;
        q.actualAns = q.u_chk ? "UP" : (q.r_chk ? "RIGHT" : "LEFT");

        const card = document.createElement('div');
        card.className = "card";
        card.id = "active-card";
        
        // Center Horizontally via Transform (Matches CSS)
        card.style.transform = `translateX(-50%)`;

        card.innerHTML = `
            <div class="card-top">
                <div class="card-q" id="q-text">${formatText(q.q)}</div>
                <div class="card-overlay-text" id="ov-text"></div>
            </div>
        `;
        
        document.getElementById('stage').appendChild(card);
        
        // Update DOCK Content
        document.querySelector('#col-left .dock-val').innerHTML = formatText(q.l_txt);
        document.querySelector('#col-up .dock-val').innerHTML = formatText(q.u_txt);
        document.querySelector('#col-right .dock-val').innerHTML = formatText(q.r_txt);
        
        bindPhysics(card, q);
    }

    // --- PHYSICS ENGINE: V158 STABLE V-CONE ---
    function bindPhysics(el, data) {
        let startX, startY, isDragging = false;
        
        // PIVOT: Exact Center of the Yellow Line
        const pivotY = window.innerHeight - 220; 
        const pivotX = window.innerWidth / 2;

        const qText = el.querySelector('#q-text');
        const ovText = el.querySelector('#ov-text');
        const dock = el.querySelector('#card-dock');
        const colLeft = document.querySelector('#col-left');
        const colRight = document.querySelector('#col-right');
        const colUp = document.querySelector('#col-up');

        el.addEventListener('touchstart', e => { isDragging=true; startX=e.touches[0].clientX; startY=e.touches[0].clientY; el.style.transition='none'; });
        
        window.addEventListener('touchmove', e => {
            if (!isDragging) return;
            const cx = e.touches[0].clientX; 
            const cy = e.touches[0].clientY;
            
            // 1. DEAD ZONE (Below Pivot)
            if (cy > pivotY) {
                const dx = cx - startX; const dy = cy - startY;
                // Move card slightly (feedback only)
                el.style.transform = `translateX(calc(-50% + ${dx*0.1}px)) translateY(${dy*0.3}px)`;
                
                qText.style.opacity = 1; ovText.style.opacity = 0;
                [colLeft, colRight, colUp].forEach(c => c.classList.remove('active'));
                
                // Analysis Trigger
                if(dy > 100) {
                    qText.style.opacity = 0; ovText.style.opacity = 1; 
                    ovText.innerText = "ANALYSIS"; ovText.style.color = "var(--gold)";
                    dock.classList.add('analysis-mode');
                } else {
                    dock.classList.remove('analysis-mode');
                }
                return;
            }

            dock.classList.remove('analysis-mode');
            ovText.style.color = "#fff";

            // 2. VECTOR LOGIC
            const dx = cx - pivotX;
            const dy = cy - pivotY; 
            let angleDeg = Math.atan2(dx, -dy) * (180 / Math.PI);
            
            // 7.5 DEGREE CLAMP (TOTAL 15 DEGREES V-CONE)
            let rot = angleDeg;
            if (rot > 7.5) rot = 7.5; if (rot < -7.5) rot = -7.5;

            const dragX = cx - startX;
            const dragY = cy - startY;
            const moveX = dragX * 0.12; 
            const moveY = dragY * 0.12;

            // Apply Rotation around anchored bottom
            el.style.transform = `translateX(calc(-50% + ${moveX}px)) translateY(${moveY}px) rotate(${rot}deg)`;
            
            // 3. SAFETY CIRCLE CHECK (Noise Filter - 40px)
            const dist = Math.sqrt(dragX*dragX + dragY*dragY);
            const NOISE_RADIUS = 40;

            if (dist < NOISE_RADIUS) {
                qText.style.opacity = 1; 
                ovText.style.opacity = 0;
                [colLeft, colRight, colUp].forEach(c => c.classList.remove('active'));
                return; 
            }

            // 4. CROSS-FADE & HIGHLIGHT
            const activeDist = dist - NOISE_RADIUS;
            const progress = Math.min(activeDist / 120, 1); // 120px active drag
            
            qText.style.opacity = 1 - progress; 
            ovText.style.opacity = progress;
            
            [colLeft, colRight, colUp].forEach(c => c.classList.remove('active'));

            // CONE LOGIC (Wider for V-Shape)
            // Up Logic: Within +/- 15 deg vector
            if (dragY < -40 && Math.abs(angleDeg) < 15) {
                ovText.innerHTML = formatText(data.u_txt); 
                if(progress > 0.1) colUp.classList.add('active');
            } else if (dragX > 40) {
                ovText.innerHTML = formatText(data.r_txt); 
                if(progress > 0.1) colRight.classList.add('active');
            } else if (dragX < -40) {
                ovText.innerHTML = formatText(data.l_txt); 
                if(progress > 0.1) colLeft.classList.add('active');
            }
        });

        window.addEventListener('touchend', e => {
            if (!isDragging) return; isDragging=false;
            const y = e.changedTouches[0].clientY;
            
            if (y > pivotY) { 
                const dy = e.changedTouches[0].clientY - startY;
                if (dy > 100) finishSwipe(el, data, "DOWN"); 
                else resetCard(el);
                return; 
            }

            const x = e.changedTouches[0].clientX - startX;
            const dragY = e.changedTouches[0].clientY - startY;
            const dist = Math.sqrt(x*x + dragY*dragY);
            
            const dx = e.changedTouches[0].clientX - pivotX;
            const dy = e.changedTouches[0].clientY - pivotY;
            let angleDeg = Math.atan2(dx, -dy) * (180 / Math.PI);

            // COMMIT (Need > 150px total drag for safety)
            if (dist > 150) {
                // Slightly wider acceptance for UP due to V-Shape
                if (dragY < -60 && Math.abs(angleDeg) < 20) finishSwipe(el, data, "UP");
                else if (x > 60) finishSwipe(el, data, "RIGHT");
                else if (x < -60) finishSwipe(el, data, "LEFT");
                else resetCard(el);
            } else {
                resetCard(el);
            }
        });
    }

    function resetCard(el) { 
        el.style.transition='transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1)'; 
        el.style.transform='translateX(-50%) rotate(0deg)'; 
        el.querySelector('#q-text').style.opacity = 1;
        el.querySelector('#ov-text').style.opacity = 0;
        document.querySelector('#card-dock').classList.remove('analysis-mode');
        document.querySelectorAll('.dock-col').forEach(c => c.classList.remove('active'));
    }

    function finishSwipe(el, data, dir) {
        if(dir === "DOWN") {
            el.style.transition='transform 0.4s ease-in';
            el.style.transform=`translateX(-50%) translateY(100vh)`;
            setTimeout(()=>{showAnalysis(data.expl); el.remove(); INDEX++; renderCard();}, 300);
            logData(data.id, "ANALYSIS", "VIEW", "");
            return;
        }

        let tx = dir === "RIGHT" ? window.innerWidth : (dir === "LEFT" ? -window.innerWidth : 0);
        let ty = dir === "UP" ? -window.innerHeight : 0;
        let rot = dir === "RIGHT" ? 7.5 : (dir === "LEFT" ? -7.5 : 0); // V-Shape Rotation
        
        el.style.transition='transform 0.25s ease-out'; 
        // Need to keep translateX(-50%)
        el.style.transform=`translateX(-50%) translate(${tx}px, ${ty}px) rotate(${rot}deg)`;

        const corr = (dir===data.actualAns); SCORE += corr?1:0; 
        logData(data.id, dir, corr?"CORRECT":"WRONG", "");
        setTimeout(()=>{el.remove(); INDEX++; renderCard();}, 250);
    }

    function showAnalysis(t) { document.getElementById('modal-text').innerHTML = `<strong>INSIGHT</strong><br><br>${formatText(t)}`; document.getElementById('analysis-modal').classList.add('open'); }
    function closeModal() { document.getElementById('analysis-modal').classList.remove('open'); }
    function logData(qid, act, res, conc) { if(BACKEND_URL) fetch(BACKEND_URL, { method:"POST", mode:"no-cors", headers:{"Content-Type":"application/json"}, body:JSON.stringify({session_id:SESSION_ID, question_id:qid, action:act, result:res, device:navigator.platform, conclusion:conc}) }); }

    function renderEnd() {
        let pct = Math.round((SCORE/POOL.length)*100);
        document.getElementById('stage').innerHTML = `<div class="card" style="justify-content:center; align-items:center;"><div style="color:var(--accent);font-size:3rem;">✓</div><div class="card-q">SESSION COMPLETE</div><h2 style="color:#fff;">${pct}% ACCURACY</h2><button class="btn btn-blue" onclick="exitSession()" style="width:80%; margin-top:20px;">RETURN TO LIBRARY</button></div>`;
    }

    async function importDataset() { 
        const r=document.getElementById('data-input').value.trim(); if(!r)return; 
        const l=r.split(/\r?\n/); let p=[]; 
        for(let i=0;i<l.length;i++){ let c=l[i].split(/\t/); if(c.length>=8 && c[0]!=="ID") p.push({id:c[0], set:c[1], dom:c[2], q:c[4], u:c[5], r:c[6], l:c[7], ans:c[8], expl:c[9]||""}); }
        if(p.length){ const tx = db.transaction([STORE_NAME],"readwrite"); tx.objectStore(STORE_NAME).put(p, p[0].set); tx.oncomplete = () => { alert("Imported!"); document.getElementById('data-input').value=""; refreshLibrary(); } }
    }
    function clearLibrary() { if(confirm("Reset Everything?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } }
</script>
</body>
</html>
